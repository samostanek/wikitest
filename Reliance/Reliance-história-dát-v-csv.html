<!--
title: Reliance - história dát v .csv a posielanie mailom
description: 
published: true
date: 2020-06-04T09:09:18.552Z
tags: 
editor: undefined
-->

<p>Historické dáta sa dajú v&nbsp;Relianci ukladať pomocou dátových tabuliek, ale iba do databázového formátu, alebo priamo do SQL databázy bežiacej na serveri. Tiež v&nbsp;Relianci nie je možnosť posielania dátových tabuliek mailom. Na toto treba použiť skripty.</p><h1>Ukladanie dát vo formáte .csv</h1><p>V&nbsp;Relianci si otvorte <i>Script Manager</i>, v&nbsp;ktorom vytvorte skript s&nbsp;názvom <i>Define</i><a href="#_ftn1"><i><strong>[1]</strong></i></a>.</p><figure class="image"><img src="/reliance-scripts-1.png"></figure><figure class="image"><img src="/reliance-scripts-2.png"></figure><p>Pôvodný kód nahraďte týmto, pričom vyznačené texty v&nbsp;hranatých zátvorkách treba nahradiť konkrétnymi hodnotami:</p><p><span style="font-family:'Times New Roman', Times, serif;">Option Explicit</span></p><p><span style="font-family:'Times New Roman', Times, serif;">function CustomFormatDate(ByVal ADate)</span><br><span style="font-family:'Times New Roman', Times, serif;">&nbsp; &nbsp; dim AYear,AMonth,ADay</span></p><p><span style="font-family:'Times New Roman', Times, serif;">&nbsp; &nbsp; AYear=Year(ADate)</span><br><span style="font-family:'Times New Roman', Times, serif;">&nbsp; &nbsp; AMonth=Month(ADate)</span><br><span style="font-family:'Times New Roman', Times, serif;">&nbsp; &nbsp; ADay=Day(ADate)</span><br><span style="font-family:'Times New Roman', Times, serif;">&nbsp; &nbsp; CustomFormatDate=<strong>[CStr(ADay)+"-"+CStr(AMonth)+"-"+CStr(AYear)</strong></span><a href="#_ftn2"><span style="font-family:'Times New Roman', Times, serif;"><strong>[2]</strong></span></a><span style="font-family:'Times New Roman', Times, serif;"><strong>]</strong></span><br><span style="font-family:'Times New Roman', Times, serif;">end function</span></p><p><span style="font-family:'Times New Roman', Times, serif;">sub LogMessage()</span><br><span style="font-family:'Times New Roman', Times, serif;">&nbsp; &nbsp; dim FSO, FileObject, FilePath, FileName, obj, LineText</span></p><p><span style="font-family:'Times New Roman', Times, serif;">&nbsp; &nbsp; FilePath = RSys.GetProjectDir + "<strong>[PRIEČINOK, KAM SA UKLADAJÚ SÚBORY (relatívne k&nbsp;súboru projektu)]</strong>"</span><br><span style="font-family:'Times New Roman', Times, serif;">&nbsp; &nbsp; FileName = FilePath + CustomFormatDate(RSys.Now) + ".csv"</span></p><p><span style="font-family:'Times New Roman', Times, serif;">&nbsp; &nbsp; LineText = ""</span><br><span style="font-family:'Times New Roman', Times, serif;">&nbsp; &nbsp; if not RSys.FileExists(FileName) then</span><br><span style="font-family:'Times New Roman', Times, serif;">&nbsp; &nbsp; &nbsp; &nbsp; LineText = "<strong>[HLAVIČKA TABUĽKY]</strong>" &amp; vbCrLf</span><br><span style="font-family:'Times New Roman', Times, serif;">&nbsp; &nbsp; else</span><br><span style="font-family:'Times New Roman', Times, serif;">&nbsp; &nbsp; &nbsp; &nbsp; LineText = ""</span><br><span style="font-family:'Times New Roman', Times, serif;">&nbsp; &nbsp; end if</span><br><span style="font-family:'Times New Roman', Times, serif;">&nbsp; &nbsp; dim objects</span><br><span style="font-family:'Times New Roman', Times, serif;">&nbsp; &nbsp; objects = Array(Array("<strong>[STANICA 1. TAGU]</strong>", "<strong>[NÁZOV 1. TAGU]</strong>"), Array("<strong>[STANICA 2. TAGU]</strong>", "<strong>[NÁZOV 2. TAGU] [,…]</strong>"))</span><br><span style="font-family:'Times New Roman', Times, serif;">&nbsp; &nbsp; For Each obj In objects</span><br><span style="font-family:'Times New Roman', Times, serif;">&nbsp; &nbsp; &nbsp; &nbsp; LineText = LineText &amp; "," + Chr(34) + RTag.GetTagValueAsStr(obj(0), obj(1)) + Chr(34)</span><br><span style="font-family:'Times New Roman', Times, serif;">&nbsp; &nbsp; Next</span><br><span style="font-family:'Times New Roman', Times, serif;">&nbsp; &nbsp; LineText = Mid(LineText, 2)</span></p><p><span style="font-family:'Times New Roman', Times, serif;">&nbsp; &nbsp; if RSys.CreateDir(FilePath) then</span><br><span style="font-family:'Times New Roman', Times, serif;">&nbsp; &nbsp; &nbsp; &nbsp; Set FSO = CreateObject("Scripting.FileSystemObject")</span><br><span style="font-family:'Times New Roman', Times, serif;">&nbsp; &nbsp; &nbsp; &nbsp; Set FileObject = FSO.OpenTextFile(FileName, 8, True)</span><br><span style="font-family:'Times New Roman', Times, serif;">&nbsp; &nbsp; &nbsp; &nbsp; FileObject.WriteLine LineText</span><br><span style="font-family:'Times New Roman', Times, serif;">&nbsp; &nbsp; &nbsp; &nbsp; FileObject.Close</span><br><span style="font-family:'Times New Roman', Times, serif;">&nbsp; &nbsp; &nbsp; &nbsp; Set FileObject = Nothing</span><br><span style="font-family:'Times New Roman', Times, serif;">&nbsp; &nbsp; &nbsp; &nbsp; Set FSO =&nbsp; Nothing</span><br><span style="font-family:'Times New Roman', Times, serif;">&nbsp; &nbsp; end if</span><br><span style="font-family:'Times New Roman', Times, serif;">end sub</span></p><p>V&nbsp;pravom paneli choďte do záložky <i>Advanced</i> a&nbsp;zaškrtnite políčko <i>Run on thread initialization</i>. Toto spôsobí, že sa skript <i>Define</i> spustí pri spustení projektu.</p><figure class="image"><img src="/relianec-scripts-3.png"></figure><p><br>Teraz vytvorte ďalší skript s&nbsp;názvom <i>AddLine</i>, kde nahraďte pôvodný kód nasledujúcim:</p><p><span style="font-family:'Times New Roman', Times, serif;">Option Explicit</span></p><p><span style="font-family:'Times New Roman', Times, serif;">LogMessage</span></p><p>Tu v&nbsp;pravom paneli choďte do záložky <i>Basic</i> a&nbsp;vyberte <i>Type – Periodic</i>. Nižšie zadajte interval, v&nbsp;akom sa majú zapisovať dáta do súboru a&nbsp;zaškrtnite <i>First time execute only after specified interval</i>.</p><figure class="image"><img src="/reliance-scripts-4.png"></figure><h1>Automatické odosielanie mailu s .csv súborom</h1><p>Na koniec skriptu <i>Define</i> pridajte nasledujúci kód:</p><p><span style="font-family:'Times New Roman', Times, serif;">function CustomFormatDateYd(ByVal ADate)</span><br><span style="font-family:'Times New Roman', Times, serif;">&nbsp; &nbsp; dim AYear,AMonth,ADay</span></p><p><span style="font-family:'Times New Roman', Times, serif;">&nbsp; &nbsp; AYear=Year(ADate)</span><br><span style="font-family:'Times New Roman', Times, serif;">&nbsp; &nbsp; AMonth=Month(ADate)</span><br><span style="font-family:'Times New Roman', Times, serif;">&nbsp; &nbsp; ADay=Day(ADate)</span><br><span style="font-family:'Times New Roman', Times, serif;">&nbsp; &nbsp; CustomFormatDateYd=CStr(ADay-1)+"-"+CStr(AMonth)+"-"+CStr(AYear)</span><br><span style="font-family:'Times New Roman', Times, serif;">end function</span></p><p><span style="font-family:'Times New Roman', Times, serif;">sub SendMail()</span><br><span style="font-family:'Times New Roman', Times, serif;">&nbsp; &nbsp; dim FilePath, FileName, FileNameYd</span><br><span style="font-family:'Times New Roman', Times, serif;">&nbsp; &nbsp; FilePath = RSys.GetProjectDir + "<strong>[PRIEČINOK, KAM SA UKLADAJÚ SÚBORY (rovnaký ako v&nbsp;prvom kóde)]</strong>"</span><br><span style="font-family:'Times New Roman', Times, serif;">&nbsp; &nbsp; FileName = FilePath + CustomFormatDate(RSys.Now) + ".csv"</span><br><span style="font-family:'Times New Roman', Times, serif;">&nbsp; &nbsp; FileNameYd = FilePath + CustomFormatDateYd(RSys.Now) + ".csv"</span><br><span style="font-family:'Times New Roman', Times, serif;">&nbsp; &nbsp; if RSys.FileExists(FileNameYd) then</span><br><span style="font-family:'Times New Roman', Times, serif;">&nbsp; &nbsp; &nbsp; &nbsp; if RInet.SendMail("<strong>[ADRESA, KAM POSLAŤ MAIL]</strong>", "<strong>[PREDMET]</strong>", "<strong>[TEXT MAILU]</strong>", FileName + ";" + FileNameYd) Then</span><br><span style="font-family:'Times New Roman', Times, serif;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RTag.SetTagValue "System", "DisplayResult", "The message was sent."</span><br><span style="font-family:'Times New Roman', Times, serif;">&nbsp; &nbsp; &nbsp; &nbsp; End If</span><br><span style="font-family:'Times New Roman', Times, serif;">&nbsp; &nbsp; else</span><br><span style="font-family:'Times New Roman', Times, serif;">&nbsp; &nbsp; &nbsp; &nbsp; If RInet.SendMail("<strong>[ADRESA, KAM POSLAŤ MAIL]</strong>", "<strong>[PREDMET]</strong>", "<strong>[TEXT MAILU]</strong>", FileName) Then</span><br><span style="font-family:'Times New Roman', Times, serif;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RTag.SetTagValue "System", "DisplayResult", "The message was sent."</span><br><span style="font-family:'Times New Roman', Times, serif;">&nbsp; &nbsp; &nbsp; &nbsp; End If</span><br><span style="font-family:'Times New Roman', Times, serif;">&nbsp; &nbsp; End If</span><br><span style="font-family:'Times New Roman', Times, serif;">end sub</span></p><p>Teraz vytvorte ďalší skript s&nbsp;názvom <i>SendByMail</i>, kde nahraďte pôvodný kód nasledujúcim:</p><p><span style="font-family:'Times New Roman', Times, serif;">Option Explicit</span></p><p><span style="font-family:'Times New Roman', Times, serif;">sendMail</span></p><p>Tu v&nbsp;pravom paneli choďte do záložky <i>Basic</i> a&nbsp;vyberte <i>Type – Periodic</i>. Nižšie zadajte interval, v&nbsp;akom sa majú posielať emaily a&nbsp;zaškrtnite <i>First time execute only after specified interval</i>.</p><p>Skript posiela&nbsp;mail s&nbsp;csv tabuľkou z&nbsp;dneskajška a&nbsp;zo včerajška.</p><h2>E-mail nastavenia</h2><p>K&nbsp;tomu, aby odosielanie mailov fungovalo, treba v&nbsp;<i>Project Structure Manager</i> zvoliť <i>PC1</i>, v&nbsp;pravom paneli otvoriť záložku E-mail a&nbsp;tu nastaviť Vaše meno, heslo, email... aby Reliance mohol používať Váš mail k&nbsp;odosielaniu správ.&nbsp;</p><p>Ak používate k&nbsp;odosielaniu mailov Gmail, treba po prihlásení do účtu, ktorý sa bude používať na odosielanie mailov povoliť prístup menej bezpečných aplikácií&nbsp;<a href="https://myaccount.google.com/lesssecureapps">tu</a> a&nbsp;v Relianci odoslať testovací mail (mala by vyskočiť chyba). Na Gmail účet, ktorý sa použil na odoslanie emailu by mal prísť email s&nbsp;upozornením – tu treba potvrdiť, že ste to Vy. Poprípade bude treba znovu povoliť prístup menej bezpečných aplikácií. Nastavenia protokolu SMTP - TLS/STARTTLS, ktoré treba prepísať do nastavení v&nbsp;Relianci sa dajú nájsť&nbsp;<a href="https://support.google.com/mail/answer/7126229?hl=sk">tu</a> (alebo sú tiež na obrázku).</p><figure class="image"><img src="/reliance-scripts-5.png"></figure><p>&nbsp;</p><p>&nbsp;</p><p><a href="#_ftnref1">[1]</a> Názov sa udáva v&nbsp;pravom paneli po vytvorení skriptu.</p><p><a href="#_ftnref2">[2]</a> Tu sa udáva, ako budú vyzerať názvy súborov csv. Funkcie CStr(ADay), CStr(AMonth)a CStr(AYear)značia aktuálny deň, mesiac a&nbsp;rok, pričom sa dajú za seba naväzovať pomocou znaku +tak, ako je to v&nbsp;kóde. Znaky v&nbsp;úvodzovkách ("-") určujú ako budú deň, mesiac ak rok oddelené. Do úvodzoviek sa dá napísať čokoľvek a&nbsp;dá sa to ľubovoľne kombinovať s CStr(ADay), CStr(AMonth) a CStr(AYear).</p>